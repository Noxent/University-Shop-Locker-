# U-Shop Smart Locker üîê

The U-Shop Smart Locker is an IoT storage system for Batangas State University. It features an ESP32 captive portal for seamless, app-free access via OTPs, and a secured, fully logged admin dashboard.

Designed to eliminate friction, the system generates its own Wi-Fi network and intercepts DNS requests to automatically present a beautifully branded, mobile-responsive web interface to the user.

## üåü Key Features

* **Captive Portal Integration:** Automatically opens the UI when a user connects to the locker's Wi-Fi network (no app or IP typing required).
* **Burn-on-Use OTPs:** Access codes are one-time-use only. Once a locker is opened, the code is permanently deleted from both RAM and non-volatile flash memory.
* **Non-Volatile Memory:** Utilizes the ESP32's `Preferences` library. If power is lost, all active codes and locker states are preserved and restored on boot.
* **Real-Time Availability Grid:** A color-coded grid lets customers instantly see which lockers are free (Red) or occupied (Gray) without exposing sensitive data.
* **Audit Logging:** Tracks the last 50 system events (e.g., "Locker #1 Unlocked by Customer", "New PIN Generated by Admin") for total security accountability.
* **FinTech-Grade UI:** A clean, responsive "BatStateU Red & White" web interface built with pure HTML/CSS/JS, embedded directly into the ESP32's memory.

---

## üõ†Ô∏è Hardware Architecture

To build this system, you will need the following components:

* **Microcontroller:** ESP32 Development Board (NodeMCU or similar)
* **Actuators:** 15x 12V Solenoid Electronic Locks
* **Switching:** 16-Channel Relay Module (Active-Low)
* **Power Supply:** * 12V, 5A+ Power Supply (Dedicated to powering the solenoids)
* 5V Step-Down Buck Converter (To power the ESP32 from the 12V line)


* **Protection:** Flyback diodes across the solenoid terminals (highly recommended to prevent back-EMF from resetting the ESP32).

### Pin Mapping

The system uses 15 GPIO pins to trigger the relays.
`const uint8_t LOCKER_PINS[15] = {23, 22, 21, 19, 18, 5, 17, 16, 4, 27, 26, 25, 33, 32, 14};`

---

## üíª Software Setup

### 1. Prerequisites

* Arduino IDE installed.
* ESP32 Board Manager installed in Arduino IDE.
* The following standard libraries (included in the ESP32 core):
* `WiFi.h`
* `WebServer.h`
* `Preferences.h`
* `DNSServer.h`



### 2. Installation

1. Clone this repository.
2. Open the `.ino` file in the Arduino IDE.
3. Ensure the `index.h` file (containing the UI and Base64 logo) is in the same directory as the `.ino` file.
4. Select your ESP32 board and COM port.
5. Compile and upload.

---

## üö∂ System Walkthrough

### The Customer Experience

1. **Connect:** The user connects their smartphone to the `U-Shop Smart Locker - 01` Wi-Fi network.
2. **Auto-Launch:** A "Sign in to network" prompt appears, automatically sliding up the BatStateU-branded portal.
3. **Check Availability:** The user taps **Customer Access** and checks the grid to find a free locker.
4. **Unlock:** The user enters the 4-digit OTP provided by the admin. The lock clicks open.
5. **Secure:** After placing their items inside, the user closes the physical door and taps **Lock & Finish Session** on their phone.

### The Admin Experience

1. **Login:** The administrator taps **Admin Login** and enters their credentials (Default: `admin` / `admin123`).
2. **Dashboard:** The admin views the real-time status of all 15 lockers.
3. **Generate:** The admin clicks **Generate** on an available locker to create a new 4-digit OTP for a customer.
4. **Override:** If a student loses their code or a locker malfunctions, the admin can trigger master overrides (**Unlock All**, **Lock All**, or individual overrides).
5. **Audit:** The admin switches to the **Audit Logs** tab to review the historical sequence of who opened what, and when.

---

## üîí Security Notes

* **Network Security:** The AP operates with WPA2-PSK encryption.
* **Data Isolation:** The `/public_status` endpoint heavily masks system state, ensuring that standard users cannot scrape the network for active OTPs.
* **Session Tokens:** When a customer opens a locker, a secondary randomized token is generated in the background. This ensures that only the device that *opened* the locker has the cryptographic authority to trigger the "Lock & Finish" command.

---

# ‚ö° Hardware Wiring & Schematic Guide

Wiring 15 solenoid locks requires careful power management. Solenoids are **inductive loads**, meaning they draw a massive spike of current when they turn on, and they shoot electricity backward when they turn off.

If wired incorrectly, this will cause your ESP32 to randomly restart, lose Wi-Fi connection, or burn out completely.

## üîã Power Supply Requirements

You **cannot** power the solenoids from the ESP32. You need an external power source.

* **Main Power Supply:** 12V DC, 5A to 10A (Depending on your solenoids. Most 12V solenoids draw ~1A to 2A, but they won't all open at the exact same time).
* **Step-Down Converter (Buck Converter):** An LM2596 to step the 12V down to 5V to safely power the ESP32 and the Relay Module's logic.

---

## üîå 1. ESP32 to Relay Module (Low Voltage Side)

The ESP32 sends 3.3V logic signals to the relay board to trigger the switches.

* **ESP32 5V (VIN) Pin** ‚û°Ô∏è 5V Output from Buck Converter
* **ESP32 GND Pin** ‚û°Ô∏è Ground from Buck Converter
* **Relay VCC / JD-VCC** ‚û°Ô∏è 5V Output from Buck Converter
* **Relay GND** ‚û°Ô∏è Ground from Buck Converter

### GPIO Pin Mapping

Connect these exact ESP32 pins to the input pins (`IN1` to `IN15`) on your 16-channel relay module.

| Locker # | ESP32 GPIO Pin | Relay Input |
| --- | --- | --- |
| Locker 01 | GPIO 23 | IN 1 |
| Locker 02 | GPIO 22 | IN 2 |
| Locker 03 | GPIO 21 | IN 3 |
| Locker 04 | GPIO 19 | IN 4 |
| Locker 05 | GPIO 18 | IN 5 |
| Locker 06 | GPIO 5  | IN 6 |
| Locker 07 | GPIO 17 | IN 7 |
| Locker 08 | GPIO 16 | IN 8 |
| Locker 09 | GPIO 4  | IN 9 |
| Locker 10 | GPIO 27 | IN 10 |
| Locker 11 | GPIO 26 | IN 11 |
| Locker 12 | GPIO 25 | IN 12 |
| Locker 13 | GPIO 33 | IN 13 |
| Locker 14 | GPIO 32 | IN 14 |
| Locker 15 | GPIO 14 | IN 15 |

---

## üß≤ 2. Relay Module to Solenoids (High Voltage Side)

Each relay on the board has three screw terminals: **NO** (Normally Open), **COM** (Common), and **NC** (Normally Closed). We will use **NO** and **COM**.

For *every* solenoid (1 through 15), wire them like this:

1. **12V Power Supply (+)** ‚û°Ô∏è Connects to the **COM (Common)** terminal on the Relay.
2. **Relay NO (Normally Open)** ‚û°Ô∏è Connects to the **Positive (+)** wire of the Solenoid.
3. **12V Power Supply GND (-)** ‚û°Ô∏è Connects directly to the **Negative (-)** wire of the Solenoid.

*How it works:* The 12V power waits at the `COM` port. When the ESP32 triggers the relay, a physical switch closes, connecting `COM` to `NO`, sending the 12V power to the solenoid to pop the lock open.

---

## üõ°Ô∏è 3. The Flyback Diode (CRITICAL SAFETY STEP)

Because solenoids use electromagnets, they create a "back-EMF" voltage spike when they turn off. This spike can be hundreds of volts and will travel back up your wires and destroy your relays or reset your ESP32.

To fix this, you must install a **Flyback Diode** (like a `1N4007`) on *every* solenoid.

* **How to install:** Place the diode directly across the two wires of the solenoid.
* **Orientation matters!** The diode has a silver stripe on one end (the cathode).
* The side with the **silver stripe** MUST connect to the **Positive (+)** side of the solenoid (the wire coming from the relay).
* The side **without the stripe** MUST connect to the **Negative (-)** side of the solenoid (the Ground wire).

If you put the diode backward, it will create a short circuit and instantly burn out!
